<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursia - –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .expense-item { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        .report { background: #f8f9fa; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nursia - –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</h1>
        
        <div id="auth-section">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <div class="form-group">
                <label>Telegram ID:</label>
                <input type="number" id="telegram-id" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID">
            </div>
            <div class="form-group">
                <label>–ò–º—è:</label>
                <input type="text" id="full-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="remember-me" checked>
                    –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è
                </label>
            </div>
            <button onclick="login()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="main-section" style="display: none;">
            <div id="message-area" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-weight: 500;"></div>
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <select id="category-select"></select>
            </div>
            <div class="form-group">
                <label>–ö–æ–º—É:</label>
                <select id="recipient-select">
                    <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                </select>
            </div>
            <div class="form-group">
                <label>–°—É–º–º–∞:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="amount" step="0.01" placeholder="0.00" style="flex: 1;">
                    <select id="currency-select" style="width: 100px;"></select>
                </div>
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞"></textarea>
            </div>
            <button onclick="addExpense()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>

            <h2>–û—Ç—á–µ—Ç—ã</h2>
            <select id="period-select" onchange="loadReports()">
                <option value="day">–î–µ–Ω—å</option>
                <option value="week">–ù–µ–¥–µ–ª—è</option>
                <option value="month" selected>–ú–µ—Å—è—Ü</option>
                <option value="year">–ì–æ–¥</option>
            </select>
            
            <div id="reports-container"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('nursia_user');
            if (savedData) {
                const userData = JSON.parse(savedData);
                const now = new Date().getTime();
                if (now < userData.expires) {
                    document.getElementById('telegram-id').value = userData.telegramId;
                    document.getElementById('full-name').value = userData.fullName;
                    login();
                } else {
                    localStorage.removeItem('nursia_user');
                }
            }
        });

        async function login() {
            const telegramId = document.getElementById('telegram-id').value;
            const fullName = document.getElementById('full-name').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: parseInt(telegramId),
                        full_name: fullName
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —á–µ–∫–±–æ–∫—Å
                    if (rememberMe) {
                        const expires = new Date().getTime() + (24 * 60 * 60 * 1000); // 24 —á–∞—Å–∞
                        const userData = {
                            telegramId: telegramId,
                            fullName: fullName,
                            expires: expires
                        };
                        localStorage.setItem('nursia_user', JSON.stringify(userData));
                    }
                    
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('main-section').style.display = 'block';
                    loadCategories();
                    loadCurrencies();
                    loadRecipients();
                    loadReports();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/expenses/categories`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const categories = await response.json();
                    const select = document.getElementById('category-select');
                    select.innerHTML = '';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        async function loadCurrencies() {
            try {
                const response = await fetch(`${API_BASE}/currencies/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('currency-select');
                    select.innerHTML = '';
                    data.currencies.forEach(currency => {
                        const option = document.createElement('option');
                        option.value = currency;
                        const symbol = data.symbols[currency] || currency;
                        option.textContent = `${currency} (${symbol})`;
                        if (currency === data.default) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–ª—é—Ç:', error);
            }
        }

        async function loadRecipients() {
            try {
                const response = await fetch(`${API_BASE}/recipients/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const recipients = await response.json();
                    const select = document.getElementById('recipient-select');
                    const firstOption = select.firstElementChild;
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    
                    recipients.forEach(recipient => {
                        const option = document.createElement('option');
                        option.value = recipient.id;
                        let typeLabel = 'üè¢'; // –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
                        if (recipient.type === 'user') typeLabel = 'üë§'; // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        if (recipient.type === 'person' || recipient.type === '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è') typeLabel = 'üë•'; // —Ñ–∏–∑–ª–∏—Ü–æ
                        option.textContent = `${typeLabel} ${recipient.name}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:', error);
            }
        }

        async function addExpense() {
            const categoryId = document.getElementById('category-select').value;
            const recipientId = document.getElementById('recipient-select').value;
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency-select').value;
            const description = document.getElementById('description').value;
            
            const expenseData = {
                category_id: parseInt(categoryId),
                amount: parseFloat(amount),
                currency: currency,
                description: description,
                expense_date: new Date().toISOString()
            };
            
            if (recipientId) {
                expenseData.recipient_id = parseInt(recipientId);
            }
            
            try {
                const url = editingExpenseId ? `${API_BASE}/expenses/${editingExpenseId}` : `${API_BASE}/expenses/`;
                const method = editingExpenseId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(expenseData)
                });
                
                if (response.ok) {
                    const categoryName = document.getElementById('category-select').selectedOptions[0].text;
                    const currencySymbols = {'UAH': '‚Ç¥', 'EUR': '‚Ç¨', 'USD': '$', 'RUB': '‚ÇΩ'};
                    const symbol = currencySymbols[currency] || currency;
                    
                    if (editingExpenseId) {
                        showMessage(`–†–∞—Å—Ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω: ${categoryName} - ${amount} ${symbol}`, 'success');
                        editingExpenseId = null;
                        currentExpenseData = null;
                    } else {
                        showMessage(`–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—Ö–æ–¥: ${categoryName} - ${amount} ${symbol}`, 'success');
                    }
                    
                    document.getElementById('amount').value = '';
                    document.getElementById('description').value = '';
                    document.getElementById('recipient-select').value = '';
                    loadReports();
                } else {
                    showMessage(editingExpenseId ? '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞' : '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞', 'error');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        async function loadReports() {
            const period = document.getElementById('period-select').value;
            
            try {
                const response = await fetch(`${API_BASE}/expenses/reports?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('reports-container');
                    container.innerHTML = '';
                    
                    if (data.expenses.length === 0) {
                        container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>';
                        return;
                    }
                    
                    // –û–±—â–∞—è —Å—É–º–º–∞ —Å–≤–µ—Ä—Ö—É
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'report';
                    totalDiv.style.background = '#28a745';
                    totalDiv.style.color = 'white';
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å–∏–º–≤–æ–ª—ã –≤–∞–ª—é—Ç
                    const currencySymbols = {'UAH': '‚Ç¥', 'EUR': '‚Ç¨', 'USD': '$', 'RUB': '‚ÇΩ'};
                    const totalsByText = Object.entries(data.totals_by_currency)
                        .map(([currency, amount]) => `${amount.toFixed(2)} ${currencySymbols[currency] || currency}`)
                        .join(', ');
                    
                    totalDiv.innerHTML = `<h4 style="margin: 10px 0;">–ò—Ç–æ–≥–æ: ${totalsByText}</h4>`;
                    container.appendChild(totalDiv);
                    
                    // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.marginTop = '20px';
                    
                    table.innerHTML = `
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 10px;">‚Ññ</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–î–∞—Ç–∞</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–í—Ä–µ–º—è</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–°—É–º–º–∞</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–ö–æ–º—É</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th style="border: 1px solid #ddd; padding: 10px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.expenses.map((expense, index) => {
                                const date = new Date(expense.expense_date);
                                const dateStr = date.toLocaleDateString('ru-RU');
                                const timeStr = date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
                                return `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${data.expenses.length - index}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${dateStr}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${timeStr}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${expense.amount} ${expense.currency}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${expense.recipient_name || '-'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">
                                            <div style="font-weight: 500;">${expense.category_name}</div>
                                            <div style="font-size: 12px; color: #666;">${expense.description || ''}</div>
                                        </td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                            <button type="button" onclick="editExpense(${expense.id})" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; margin-right: 5px; cursor: pointer;">‚úèÔ∏è</button>
                                            <button type="button" onclick="deleteExpense(${expense.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    `;
                    
                    container.appendChild(table);
                    
                    // –û–±—â–∞—è —Å—É–º–º–∞ —Å–Ω–∏–∑—É
                    const totalDiv2 = document.createElement('div');
                    totalDiv2.className = 'report';
                    totalDiv2.style.background = '#28a745';
                    totalDiv2.style.color = 'white';
                    totalDiv2.style.marginTop = '20px';
                    totalDiv2.innerHTML = `<h4 style="margin: 10px 0;">–ò—Ç–æ–≥–æ: ${totalsByText}</h4>`;
                    container.appendChild(totalDiv2);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', error);
            }
        }

        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.style.display = 'block';
            messageArea.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            messageArea.style.color = type === 'success' ? '#155724' : '#721c24';
            messageArea.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        async function deleteExpense(expenseId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—Ö–æ–¥?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/expenses/${expenseId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showMessage('–†–∞—Å—Ö–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
                    loadReports();
                } else {
                    showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        let editingExpenseId = null;
        let currentExpenseData = null;

        async function editExpense(expenseId) {
            editingExpenseId = expenseId;
            
            try {
                const response = await fetch(`${API_BASE}/expenses/reports?period=year`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const expense = data.expenses.find(e => e.id === expenseId);
                    if (expense) {
                        currentExpenseData = expense;
                        
                        // –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                        document.getElementById('category-select').value = expense.category_id || '';
                        document.getElementById('recipient-select').value = expense.recipient_id || '';
                        document.getElementById('amount').value = expense.amount;
                        document.getElementById('currency-select').value = expense.currency || 'UAH';
                        document.getElementById('description').value = expense.description || '';
                        
                        showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ #${expenseId}. –ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥"`, 'success');
                    }
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }
    </script>
</body>
</html>